name: CI/CD

on:
  push:
    branches: [main, qa]
  pull_request:
    branches: [qa]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - deploy-qa
          - promote-to-main

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci && cd ..

      - name: Build client
        run: |
          cd client && npm run build

      - name: Start test server
        run: |
          cp data/thread.db data/thread-test.db
          PORT=4000 DATABASE_PATH=${{ github.workspace }}/data/thread-test.db node server/index.js &
          sleep 5

      - name: Run Playwright tests
        run: npx playwright test --reporter=html

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 7

  deploy-qa:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/qa' && github.event_name == 'push'
    environment:
      name: qa
      url: https://localhost:4000
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci && cd ..

      - name: Build client
        run: |
          cd client && npm run build

      - name: Create test database
        run: |
          cp data/thread.db data/thread-test.db

      - name: Deploy to QA (SSH)
        run: |
          echo "Deploying to QA environment..."
          # In a real scenario, this would SSH to your server and:
          # 1. Pull latest qa branch
          # 2. Run npm run build
          # 3. Restart pm2 service
          echo "QA deployment would run:"
          echo "  git checkout qa && git pull"
          echo "  cd client && npm run build"
          echo "  pm2 restart thread-test"

  promote-to-main:
    name: Promote to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: production
      url: https://localhost:3000
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: qa
          fetch-depth: 0

      - name: Merge to main
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git checkout main
          git merge qa --no-ff -m "chore: promote qa to production"
          git push origin main

      - name: Build production
        run: |
          cd client && npm run build

      - name: Deploy to Production (SSH)
        run: |
          echo "Deploying to Production..."
          echo "Production deployment would run:"
          echo "  git checkout main && git pull"
          echo "  cd client && npm run build"
          echo "  pm2 restart thread"

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: promote-to-main
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://localhost:3000
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci && cd ..

      - name: Build client
        run: |
          cd client && npm run build

      - name: Deploy to Production (SSH)
        run: |
          echo "Deploying to Production..."
          # In a real scenario, this would SSH to your server
          echo "pm2 restart thread"
